# kampo_assist
## サービス概要
医療従事者が、患者の症状や体質・既往歴などを入力することで、候補となる漢方薬をある程度まで自動で絞り込んでくれる「漢方処方支援アプリ」です。最終的な処方判断は医療従事者が行う前提で、その前段階の「候補出し・整理」をサポートします。

本サービスは、医療領域に関わる情報を扱うため、以下の点を強く意識して設計しています。

医療系サービスで配慮すべきリスク
* 誤った情報が判断や処方選択に影響を与える可能性がある
* アプリの内容によっては「診断」「治療行為」とみなされ、薬事法等の対象となる可能性がある

本サービスの前提と目的
本アプリは 診断や治療行為・処方決定を行うものではありません。
「自覚症状や現在診断された病名の入力に応じて、関連する漢方薬の候補を整理して提示する」
という 支援ツール に徹しています。
* 最終的な判断は必ず医療従事者が行う
* 自動的に処方を決定したり、医療行為に該当する機能は提供しない
* 判断材料の整理・候補提示に限定することで、安全性と法的リスクを回避

## 本番環境URL
https://kampoassist.com  
※ Cloudflare + HTTPS 対応済み

## このサービスへの思い・作りたい理由
父と話しているときに、「漢方って、もっと選びやすくなる仕組みがあればいいのに」という話題になったことがきっかけです。
私は医療従事者ではないため、基本的には自分で調べた内容を参考にしながら作っています。https://www.pmda.go.jp/　ここのサイトをよく参考にしました。
一般的な薬は傷病に基づいて選択できますが、漢方薬は、患者が現時点で呈している病状を陰陽・虚実，気血水，五臓など，漢方医学のカテゴリーで総合的にとらえた診断つまり証に基づく処方であり、漢方非専門医が、短時間の外来診療で、全ての分野を的確に処方する事が難しいと聞きました。
そうした「選びにくさ」を少しでも減らすために、
* 候補をいくつかに絞り込む
* 処方に至った判断基準を見える化する
といった工夫で、現場の負担を少しでも軽くできればと考え、このサービスを作ろうと思いました。
また、身近に医療関係者である父と妹がいるため、内容については二人にも確認してもらっています。


## ユーザー層について
決めたユーザー層についてどうしてその層を対象にしたのかそれぞれ理由を教えてください。

想定しているユーザー層と、それぞれを対象にした理由は以下のとおりです。

* 医師（一般内科・心療内科など、漢方も扱う医師）
  * 漢方を処方したいものの、専門医ではない場合は「どの漢方を選ぶか」で迷う場面が多い。
  * 外来は非常に多忙で、1人の患者にじっくり漢方を検討する時間が限られており、まず候補を数種類まで絞ってくれるツールがあると処方選択がスムーズになるため。

* 薬剤師（調剤薬局・病院薬剤部）
  * 処方提案や疑義照会の際に、「この症状ならこういう漢方も候補になり得る」という根拠を示す補助資料として活用しやすい。

* 漢方に関心を持ち始めた若手医療従事者（研修医・若手薬剤師など）
  * 本格的に漢方を学ぶ前段階で、「症状からどの漢方が候補に上がるのか」を直感的に理解できる学習ツールとして役立つ。
  * 先輩に聞く前に、自分で仮説を立てたり調べたりする際の補助としても有用。

* 漢方に興味を持ち始めた一般の方
  * 一般的な検索は複雑でわかりにくいが、本サービスなら症状から気軽に候補を絞れるため、入門として使いやすい。

※なお、一般の患者さんではなく主に「医療関係者」を対象としているのは、あくまで最終的な医療判断は専門家が行うべきであり、本サービスはその前段階における情報整理・候補提示に特化させたいからです。


## サービスの利用イメージ
利用フロー（イメージ）
1. ユーザーがアプリにアクセス
2. 患者さんの情報を入力
    * 主訴（例：冷え・不眠・食欲不振 など）
    * 体質・傾向（例：虚証／実証、冷えやすい、のぼせやすい など）
3. 条件を選択肢（チェックボックス・プルダウンなど）で入力
4. システムが条件にマッチする漢方薬をスコアリングし、候補を数個まで絞って提示
5. 各漢方の
    * 効果適応
    * 評価点を簡潔に確認できる
6. ユーザーはその中から、患者さんに合いそうなものをさらに精査し、最終的な処方を決定
得られる価値
* 候補出しの時間を短縮できる → 外来の負担軽減
* 「なんとなく」ではなく、条件に基づいて候補を見せてくれる → 判断の納得感が高まる
* 若手にとっては、漢方の学習ツールとしても機能する → 教育的価値
* 患者さんへの説明にも使える → 「なぜこの漢方なのか」を言語化しやすい


## ユーザーの獲得について
想定したユーザー層に対してそれぞれどのようにサービスを届けるのか現状考えていることがあれば教えてください。
身近な医療関係者へのヒアリング＆トライアル提供
* まずは父を含めた身近な医療従事者に実際に触ってもらい、フィードバックをもらう。
* 小さなクリニックや薬局に限定して、クローズドベータのような形で試してもらう。

情報発信（ブログ・Xなど）
* 「漢方でこんな時どう選ぶ？」のような記事を書き、その中でアプリのスクリーンショットや使い方を紹介。
* 漢方処方に悩んでいる医療従事者に届くようなキーワードで発信する。


## サービスの差別化ポイント・推しポイント
似たようなサービスが存在する場合、そのサービスとの明確な差別化ポイントとその差別化ポイントのどこが優れているのか教えてください。
独自性の強いサービスの場合、このサービスの推しとなるポイントを教えてください。

漢方の候補を選ぶものはあるが、病状・症状合わして絞るものは見た所ないので推しになると思います。
1. 「病名」と「症状・体質」で絞れる
  * 既存の医薬品検索は、病名や主な効能で絞り込むものが多い。
  * 本サービスは、漢方特有の「症状」「体質」「証」などの組み合わせから候補を絞る点が特徴。

2. 漢方専用の検索ロジック
  * 一般薬のような単純な「病名 → 薬」ではなく、
    * 複数の症状
    * 体質傾向を加味してスコアリングする設計を想定。
  * 「この症状には特に強く効く」といった重み付けができるようにすることで、漢方の専門性に寄せた検索が可能。


3. ブラックボックス化しがちな判断を「見える化」
  * 各漢方が選ばれた理由（どの症状にマッチしているか）を一覧で表示することで、
    * 「なぜこの漢方が上位に来ているのか」が一目で分かるようにする。
  * これにより、若手医療従事者の学習ツールとしても機能する点が推しポイント。

4. 本サービスは、医学的内容の正確性を担保するため、甲状腺・糖尿病クリニック中の島　院長 井上 篤 医師による監修を受けております。
   症状・体質と漢方薬の対応関係、適応情報など、医療知識を要する部分については医療従事者のレビューを経て反映しています。

## テスト・品質方針
- テスト方針は [docs/test_policy.md](docs/test_policy.md) に記載しています

## CI / 品質管理
Pull Request 作成時に GitHub Actions により以下を自動実行しています。
- Rubocop によるコードスタイルチェック
- Rails / Gem のセキュリティスキャン（Brakeman / bundler-audit）
- テスト（test / system test）
※ RSpec 導入後は RSpec 実行へ移行予定

## CI / Test
本プロジェクトでは GitHub Actions を用いて、Pull Request 作成時に以下を自動実行しています。
- RuboCop（コードスタイルチェック）
- RSpec（自動テスト）
- セキュリティスキャン（Brakeman / bundler-audit）

## 機能候補
現状作ろうと思っている機能、案段階の機能をしっかりと固まっていなくても構わないのでMVPリリース時に作っていたいもの、本リリースまでに作っていたいものをそれぞれ分けて教えてください。

MVPリリース時に実装したい機能

症状・体質と漢方の紐付け（多対多）
  * 「この症状に特にマッチする度合い」をスコア（重み）で管理
候補漢方の検索・スコアリング機能
  * ヒットした項目に応じてスコアを加算し、スコア順に表示

患者状態の入力画面
* 症状・体質のチェックボックス

候補漢方の検索・スコアリング機能
  * ヒットした項目に応じてスコアを加算し、スコア順に表示

漢方詳細画面（簡易版）
  * 適応症
  * よく使われるパターン

漢方詳細画面（簡易版）
  * 適応症
  * よく使われるパターン
  * 注意点・禁忌の簡単な表示

本リリースまでに追加したい機能
* ユーザー登録・ログイン機能（医療従事者アカウント）
* お気に入り・よく使う漢方の登録
* ユーザーが自分の言葉で症例メモを残せる


## 使用する技術スタック
一般的なCRUD以外の実装予定の機能についてそれぞれどのようなイメージで実装する予定なのか現状考えているもので良いので教えて下さい。
サービスを実装するための技術スタックについて、以下のような観点で記載してください。

フレームワーク
* バックエンド: Ruby on Rails 7系
    * 理由：自分の得意スタックであり、CRUD画面＋検索機能＋管理画面の実装効率が高い。
データベース
* PostgreSQL
    * Railsとの相性が良く、将来的に全文検索・JSONフィールドなども活用しやすい。
    * Heroku / Render など多くのPaaSで標準サポートされている。
デプロイ先
* Render または Fly.io などのPaaS
    * Railsアプリを簡単にデプロイできるサービス。
    * 初期は無料〜低コストで運用できるプランを想定。
使用予定のライブラリ・Gem
* 権限管理
    * Pundit：
        * 一般ユーザー（医療従事者）と管理者（マスタ編集権限あり）を分ける
* 検索・絞り込み
    * Ransack：症状・体質などの検索フォーム構築
        * ただし、独自スコアリング部分はサービスクラスやスコープで実装
* ページネーション
    * kaminari または pagy：検索結果一覧のページング
* 管理画面
    * administrate や rails_admin など（必要に応じて検討）   

# README初期セットアップ 完了済みタスクまとめ
本プロジェクトで、開発開始からここまでに実施した初期セットアップ内容をまとめます。環境構築の再現性を高めるため、作業ログとして記録しています。

1. Rails プロジェクトの作成
以下のコマンドで新規 Rails アプリを作成しました。

rails new kampo_assist
作成後、GitHub にリポジトリを作成し、main ブランチへ初回 push を完了。

Ruby バージョンの確認
Ruby 3.2.2

2. TOP ページ（Home#index）の作成
コントローラを作成：

rails g controller home index
ルート設定を追加：

config/routes.rb
root "home#index"

ブラウザで動作確認済み：
 http://localhost:3000

3. RuboCop（コード解析ツール）のセットアップ
Rails 8 標準の rubocop-rails-omakase が自動導入されているため、.rubocop.yml は既に存在しており、基本設定も完了済み。
RuboCop の動作確認：

bundle exec rubocop
結果：

30 files inspected, no offenses detected
→ Omakase スタイルに準拠し、現状コードに問題なし。

4. dotenv の準備（環境変数管理）
.env ファイルを作成：

touch .env
.gitignore によって Git 管理外であることも確認済み。
今後 API キーや環境変数はここへ記述する。

5. 開発サーバー動作確認
以下のコマンドで起動し、正常動作することを確認：

bin/rails s
アクセス URL：
 http://localhost:3000

6. RSpec（テスト環境）の導入
RSpec の導入と初期化：

bundle add rspec-rails --group "development,test"
bin/rails g rspec:install
RSpec の動作確認：

bundle exec rspec
基本的なテスト設定が完了し、以降の開発で利用可能。

 テストの実行方法
プロジェクトのテストはすべて RSpec で実行します。
▼ 全テスト実行

bundle exec rspec
▼ 特定ディレクトリのみ（例：リクエストスペック）

bundle exec rspec spec/requests

7. Render 用の Gem 設定（PostgreSQL 使用）

開発では SQLite、本番では PostgreSQL を利用するため Gemfile を調整：

group :production do
  gem "pg", "~> 1.5"
end


push して反映完了。

8. 本番用 database.yml の設定（Rails 8 / Solid 構成）

Rails 8 は SolidCache / SolidQueue / SolidCable のため
production で複数の DB 接続が必要。

以下を config/database.yml に追加：

production:
  primary:
    url: <%= ENV["DATABASE_URL"] %>

  cache:
    url: <%= ENV["DATABASE_URL"] %>

  queue:
    url: <%= ENV["DATABASE_URL"] %>

  cable:
    url: <%= ENV["DATABASE_URL"] %>


※ これを設定しないと以下のエラーが発生する：

The `cable` database is not configured for the `production` environment.

9. Render で Web Service を作成

GitHub と Render を連携

リポジトリ kampo_assist を選択

デプロイ対象ブランチ: main

設定：

Build コマンド
bundle install && bundle exec rake db:migrate

Start コマンド
bundle exec puma -C config/puma.rb

10. Render の環境変数設定

Render Dashboard → Environment Variables に設定：

KEY	VALUE
DATABASE_URL	Render が自動生成
RAILS_ENV	production
RACK_ENV	production
SECRET_KEY_BASE	Render の Generate を利用
11. デプロイとエラー対応

最初のデプロイで発生した SolidCable エラー：

The `cable` database is not configured…


→ database.yml を修正して再デプロイ
→ デプロイ成功

12. 本番環境での動作確認

Render のログにて以下を確認：

アプリ起動成功

/assets/* へのアクセスがログに記録

実際の Web ページが閲覧できる

ここまでで完了したセットアップ一覧
・Rails プロジェクト作成
・GitHub リポジトリ作成 & push
・Home#index 実装
・RuboCop（Rails 8 標準）
・dotenv 設定
・RSpec 導入
・Render へデプロイ準備
・PostgreSQL 化
・database.yml 調整（Solid 系対応）
・Render で環境変数設定
・本番デプロイ成功

This README would normally document whatever steps are necessary to get the
application up and running.

Things you may want to cover:

* Ruby version

* System dependencies

* Configuration

* Database creation

* Database initialization

* How to run the test suite

* Services (job queues, cache servers, search engines, etc.)

* Deployment instructions

* ...

### 検索履歴（SearchSession）
- 過去の検索条件を保存し、再検索できる機能
- 詳細な仕様は以下を参照  
  - [SearchSession 仕様書](docs/search_session.md)

## 管理者ユーザー（Admin）の作成方法

本アプリでは、管理画面（`/admin`）へのアクセスは  
**admin 権限を持つユーザーのみ**許可されています。

### 前提
- 事前にユーザー登録が完了していること

---

### 方法①：Railsコンソールから付与（推奨）

開発環境または本番環境で Rails コンソールを起動します。

bash
bin/rails c

管理者にしたいユーザーを取得し、role を admin に変更します。

user = User.find_by!(email: "admin@example.com")
user.update!(role: :admin)
確認：

user.admin_user? # => true

方法②：管理者ユーザーを新規作成する場合
User.create!(
  email: "admin@example.com",
  password: "password",
  password_confirmation: "password",
  role: :admin
)

注意点

role のデフォルトは user です

一般ユーザーは /admin 配下にアクセスできません（403）

管理者権限の付与は Railsコンソール経由でのみ行ってください


---

## ③ README編集後の確認
- `/admin` に adminユーザーで入れる
- 一般ユーザーでは 403 になる
- README を読めば **第三者でも再現できる**

---

## ④ コミット
```bash
git add README.md
git commit -m "docs: add admin user creation and role assignment steps"

UI / デザイン方針（Tailwind CSS）
本アプリでは、Tailwind CSS を用いて UI を設計しています。  
共通レイアウト・余白・文字サイズなどの設計基準は、以下のドキュメントにまとめています。
[UI Design Guidelines](docs/ui-design-guidelines.md)