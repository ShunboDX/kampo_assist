# SearchSession（検索履歴）仕様

## 目的
検索の試行履歴を保存し、ユーザーが過去の検索条件を確認・再利用できるようにする。

---

## 保存対象
- ログインユーザーのみ保存する
- 未ログイン時は履歴を保存しない（DBには記録しない）

---

## 保存タイミング
- 検索結果ページ（results）が表示されたタイミングで保存する
- 検索結果が0件でも保存する  
  - 条件として実行した事実を履歴として残すため

※ 例外発生・不正パラメータ等で results を正常表示できない場合は保存しない

---

## 保存内容
- 検索条件（クエリパラメータ）のみを保存する
  - medical_area_ids（Step1）
  - disease_ids（Step1）
  - symptom_ids（Step2）
  - 今後追加される条件も同様に保存対象とする

- 表示用文字列（病名名・症状名など）は保存しない
  - 表示時に ID → name をDB参照して生成する
  - 名称変更への追従・データ二重管理回避のため

---

## 再検索仕様
- 履歴から「この条件で再検索」できる導線を提供する
- 同じ検索条件で results に直接遷移する
  - Step1 / Step2 画面への自動反映は行わない

---

## 重複の扱い
- 同一条件の検索は履歴を1件に集約する
- 既存レコードを更新し、最新の履歴として扱う

※ 同一条件は、保存する検索条件が完全一致するものと定義する

---

## 保存件数の上限
- ユーザーごとに最大100件まで保存する
- 上限を超えた場合は、古い履歴から削除する

---

## セキュリティ / アクセス制御
- 検索履歴は本人のみ閲覧可能
- index / show はログイン必須
- 他人の履歴IDを指定しても参照できない（404 または 403 で統一）

---

## 設計方針（補足）
- 検索条件は JSON 形式で保存する
- 同一条件判定のため、ID配列は昇順にソートして保存する
