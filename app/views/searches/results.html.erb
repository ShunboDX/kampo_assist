<h1>漢方検索 結果一覧</h1>
<div class="mb-3 d-flex gap-2">
  <% back_to_step1_params = params.permit(medical_area_ids: [], disease_ids: []) %>
  <% back_to_step2_params = params.permit(medical_area_ids: [], disease_ids: [], symptom_ids: []) %>

  <div class="btn-area">
    <%= link_to "Step1に戻る",
                step1_search_path(back_to_step1_params),
                class: "btn btn-outline-secondary btn-nav" %>

    <%= link_to "Step2に戻る",
                step2_search_path(back_to_step2_params),
                class: "btn btn-secondary btn-nav" %>
  </div>
</div>

<!-- ★ここ：ログイン誘導（未ログイン時のみ） -->
<% if @show_login_prompt %>
  <div class="alert alert-info">
    ログインすると検索履歴を保存でき、あとから同じ条件で再検索できます。
    <%= link_to "ログインする", login_path, class: "btn btn-sm btn-primary ms-2" %>
  </div>
<% end %>

<!-- 条件の確認表示 -->
<div class="mb-3">
  <h2 class="h5">選択した条件</h2>

  <p>
    <strong>領域：</strong>
    <% if @medical_areas.present? %>
      <%= @medical_areas.map(&:name).join(" / ") %>
    <% else %>
      なし
    <% end %>
  </p>

  <p>
    <strong>病名：</strong>
    <% if @diseases.present? %>
      <%= @diseases.map(&:name).join(" / ") %>
    <% else %>
      なし
    <% end %>
  </p>

  <p>
    <strong>症状：</strong>
    <% if @symptoms.present? %>
      <%= @symptoms.map(&:name).join(" / ") %>
    <% else %>
      なし
    <% end %>
  </p>
</div>

<% if logged_in? && @search_session.present? %>
  <div class="mb-4 p-3 border rounded">
    <h2 class="h5 mb-2">この検索のメモ（上書き保存）</h2>

    <%= form_with url: search_case_note_path, method: :patch do |f| %>
      <%= hidden_field_tag :search_session_id, @search_session.id %>
      <%= hidden_field_tag :return_to, request.fullpath %>

      <%= f.text_area :body,
                      name: "case_note[body]",
                      value: @search_case_note&.body,
                      rows: 5,
                      class: "form-control" %>

      <div class="mt-2">
        <%= f.submit "保存", class: "btn btn-primary btn-sm" %>
      </div>
    <% end %>
  </div>
<% end %>

<hr>

<% if @no_condition %>
  <!-- 条件が一切選ばれていないパターン -->
  <div class="alert alert-warning">
    条件が選択されていません。<%= link_to "Step1からやり直してください", step1_search_path %>。
  </div>

<% elsif @results.blank? %>
  <!-- 条件はあるがヒット0件 -->
  <p>条件に一致する漢方は見つかりませんでした。</p>

<% else %>
  <!-- ヒット件数 -->
  <p><%= @results.size %>件ヒットしました。</p>

  <ul class="list-group">
    <% @results.each do |result| %>
      <li class="list-group-item">
        <h3 class="h5 mb-1">
          <%= link_to result.kampo.name,
                kampo_path(
                    result.kampo,
                    search_session_id: @search_session&.id,
                    medical_area_ids: params[:medical_area_ids],
                    disease_ids:      params[:disease_ids],
                    symptom_ids:      params[:symptom_ids]
                ) %>
        </h3>
        <% if result.kampo.note.present? %>
          <p class="mb-1 text-muted">
            <%= truncate(result.kampo.note, length: 300) %>
          </p>
        <% end %>

        <small>
          合計スコア: <%= result.total_score %>
          （病名: <%= result.disease_score %> / 症状: <%= result.symptom_score %>）
        </small>
      </li>
    <% end %>
  </ul>
<% end %>
