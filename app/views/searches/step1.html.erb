<div class="search-step1-container">
    <h1>漢方検索 ステップ1：領域と病名の選択</h1>

    <% steps = ["STEP1:傷病選択", "STEP2:症状選択", "検索結果"] %>
    <% current = search_step_current %>
    <% progress = ((current - 1).to_f / (steps.size - 1) * 100).round %>

    <div class="mb-3" style="--progress: <%= progress %>%;">
    <%= render "shared/step_indicator", steps: steps, current: current %>
    </div>

    <div class="search-step1-layout">

        <div class="search-step1-areas">
            <%= form_with url: step1_search_path,
                    method: :get,
                    local: true,
                    html: { data: { controller: "auto-submit" } } do %>
                <div class="search-step1-layout">
                    <!-- 左：領域一覧（複数選択可） -->
                    <div class="search-step1-areas">
                        <h2 class="h5 mb-3">領域を選択（複数可）</h2>

                        <% selected_ids = Array(params[:medical_area_ids]) %>

                        <% @medical_areas.each do |area| %>
                            <div class="form-check mb-1">
                                <%= check_box_tag "medical_area_ids[]",
                                                    area.id,
                                                    selected_ids.include?(area.id.to_s),
                                                    id: "medical_area_#{area.id}",
                                                    class: "form-check-input",
                                                    data: { action: "change->auto-submit#submit" } %>
                                <%= label_tag "medical_area_#{area.id}",
                                                area.name,
                                                class: "form-check-label" %>
                            </div>
                        <% end %>

                    </div>
                </div>
            <% end %>
        </div>

        <div class="search-step1-diseases">
            <% if @diseases.present? %>
                <%= form_with url: step2_search_path, method: :get, local: true do %>
                    <% Array(params[:medical_area_ids]).each do |area_id| %>
                        <%= hidden_field_tag "medical_area_ids[]", area_id %>
                    <% end %>

                    <h2 class="h5 mb-3">病名を選択してください（複数可）</h2>

                    <div class="disease-list">
                        <% @diseases.each do |disease| %>
                            <div class="disease-item">
                                <label class="disease-label">
                                    <%= check_box_tag "disease_ids[]",
                                                    disease.id,
                                                    Array(params[:disease_ids]).include?(disease.id.to_s),
                                                    id: "disease_#{disease.id}",
                                                    class: "disease-checkbox" %>
                                    <span><%= disease.name %></span>
                                </label>
                            </div>
                        <% end %>
                    </div>
                
                    <%= submit_tag "症状を選ぶ（ステップ2へ）",
                                class: "btn btn-primary" %>
                <% end %>
            <% end %>
        </div>
    </div>
    <%= link_to "病名を選ばず次へ", step2_search_path, class: "btn btn-outline-secondary" %>
</div>